<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>U2F Demo</title>
    <script src="js/u2f-api-1.1.js" type="application/javascript"></script>
    <script type="application/javascript">
        APPID = "https://localhost:8443"

        function _Base64ToArrayBuffer (base64) {
            base64 = base64.replace(/_/g, '/').replace(/-/g, '+'); // web safe
            var binary_string = window.atob(base64);
            var len = binary_string.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes;
        }

        function _ArrayBufferToBase64(arrayBuffer) {
            var dView = new Uint8Array(arrayBuffer);
            var arr = Array.prototype.slice.call(dView);
            var arr1 = arr.map(function(item){
                return String.fromCharCode(item);
            });
            var b64 = window.btoa(arr1.join(''));
            return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function _ArrayBufferToVBase64(arrayBuffer) {
            var dView = new Uint8Array(arrayBuffer);
            var arr = Array.prototype.slice.call(dView);
            var arr1 = arr.map(function(item){
                return String.fromCharCode(item);
            });
            var b64 = window.btoa(arr1.join(''));
            return b64;
        }

        function DoRegistration() {
            var RegistrationData = {
                challenge: "dG7vN-E440ZnJaKQ7Ynq8AemLHziJfKrBpIBi5OET_0",
                appId:     APPID,
                version:   "U2F_V2"
            };

            u2f.register(APPID,
                [RegistrationData],
                [],
                function(data) {
                    if(data.errorCode) {
                        document.getElementById("result").innerText = "U2F failed with error: " + data.errorCode;
                        return;
                    }
                    document.getElementById("result").innerText = "Response\n\n";
                    document.getElementById("result").innerText += JSON.stringify(data, null, 4);
                    document.getElementById("result").innerText += "\n\nclientData\n\n";
                    document.getElementById("result").innerText += JSON.stringify(JSON.parse(atob(data.clientData), null, 4));

                    var parsedData = _Base64ToArrayBuffer(data.registrationData)
                    // var magic = parsedData[0]
                    var userPubkey = parsedData.slice(1, 1+65)
                    var keyHandleLength = parsedData[66]
                    var keyHandle = parsedData.slice(67, 67 + keyHandleLength)
                    var n = 67 + keyHandleLength

                    var l = parsedData[n+1]
                    var n_bytes = 1
                    if (l>0x80) {
                        n_bytes = l - 0x80
                        l = 0
                        for (i=2;i<2+n_bytes;i++) {
                            l = l * 256 + parsedData[n+i]
                        }
                    }
                    var certLen = 2 + n_bytes + l
                    var cert = parsedData.slice(67 + keyHandleLength, 67 + keyHandleLength + certLen)
                    var signature = parsedData.slice(67 + keyHandleLength + certLen, parsedData.length)

                    document.getElementById("keyhandle").innerText = _ArrayBufferToBase64(keyHandle)
                    document.getElementById("pubkey").innerText = _ArrayBufferToBase64(userPubkey)
                    document.getElementById("cert").innerText = _ArrayBufferToVBase64(cert)
                    document.getElementById("signature").innerText = _ArrayBufferToBase64(signature)
                });
        }

        function DoSignRequest() {
            var SignRequestData = {
                version:    "U2F_V2",
                keyHandle:  document.getElementById("keyhandle").innerText,
                transports: [],
                appId:      APPID,
            };
            u2f.sign(APPID,
                "dG7vN-E440ZnJaKQ7Ynq8AemLHziJfKrBpIBi5OET_0",
                [SignRequestData],
                function (data) {
                    if(data.errorCode) {
                        document.getElementById("result").innerText = "U2F failed with error: " + data.errorCode;
                        return;
                    }
                    document.getElementById("result").innerText = "Response\n\n";
                    document.getElementById("result").innerText += JSON.stringify(data, null, 4);
                    document.getElementById("result").innerText += "\n\nclientData\n\n";
                    document.getElementById("result").innerText += JSON.stringify(JSON.parse(atob(data.clientData), null, 4));
                }
            )
        }
    </script>
</head>
<body>
    <h1>U2F Demo</h1>
    <p>
        Demo page for U2F stuff.
    </p>
    <p>
        Key Handle
    </p>
    <pre id="keyhandle">

    </pre>
    <p>
        Public Key
    </p>
    <pre id="pubkey">
    </pre>
    <p>
        Cert
    </p>
    <pre id="cert">
    </pre>
    <p>
        Signature
    </p>
    <pre id="signature">
    </pre>
    <form>
        <button type="button" onclick="DoRegistration()">Register</button>
        <button type="button" onclick="DoSignRequest()">Sign</button>
    </form>
    <pre id="result">

    </pre>
</body>
</html>